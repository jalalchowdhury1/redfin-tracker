name: Test Google Sheets Connection

on:
  workflow_dispatch:

jobs:
  test-sheets:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install gspread google-auth google-api-python-client

      - name: Test Google Sheets Write
        env:
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          SHEET_URL: https://docs.google.com/spreadsheets/d/1OrContixGYzHNT_DaO76p3rP1nvNamRs9r3fuJLsf-k/edit
        run: |
          python3 - <<'EOF'
          import os, json
          from google.oauth2.service_account import Credentials
          from googleapiclient.discovery import build

          creds_json = os.environ["GOOGLE_SHEETS_CREDENTIALS"]
          creds_dict = json.loads(creds_json)
          print(f"Service account: {creds_dict.get('client_email')}")

          SPREADSHEET_ID = "1OrContixGYzHNT_DaO76p3rP1nvNamRs9r3fuJLsf-k"

          # Test A: Read-only scope - should work
          print("\n--- Test A: Read with spreadsheets.readonly scope ---")
          try:
              creds = Credentials.from_service_account_info(
                  creds_dict,
                  scopes=["https://www.googleapis.com/auth/spreadsheets.readonly"]
              )
              svc = build("sheets", "v4", credentials=creds)
              result = svc.spreadsheets().get(spreadsheetId=SPREADSHEET_ID).execute()
              print(f"✓ Read OK: '{result.get('properties', {}).get('title')}'")
          except Exception as e:
              print(f"✗ Read FAILED: {e}")

          # Test B: Full scope - write a single cell using raw API
          print("\n--- Test B: Write with full spreadsheets scope (raw API) ---")
          try:
              creds = Credentials.from_service_account_info(
                  creds_dict,
                  scopes=["https://www.googleapis.com/auth/spreadsheets"]
              )
              svc = build("sheets", "v4", credentials=creds)
              body = {"values": [["$RAW-TEST"]]}
              result = svc.spreadsheets().values().update(
                  spreadsheetId=SPREADSHEET_ID,
                  range="Redfin!D2",
                  valueInputOption="RAW",
                  body=body
              ).execute()
              print(f"✓ Write SUCCESS: {result.get('updatedCells')} cell(s) updated")
          except Exception as e:
              print(f"✗ Write FAILED: {e}")

          # Test C: gspread using service_account_from_dict (modern API)
          print("\n--- Test C: Write with gspread.service_account_from_dict ---")
          try:
              import gspread
              client = gspread.service_account_from_dict(creds_dict)
              sh = client.open_by_key(SPREADSHEET_ID)
              ws = sh.worksheet("Redfin")
              ws.update_cell(2, 4, "$GSPREAD-TEST")
              print("✓ gspread write SUCCESS")
          except Exception as e:
              print(f"✗ gspread write FAILED: {e}")

          EOF
