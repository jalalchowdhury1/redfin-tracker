name: Test Google Sheets Connection

on:
  workflow_dispatch:

jobs:
  test-sheets:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install gspread google-auth

      - name: Test Google Sheets Write
        env:
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          SHEET_URL: https://docs.google.com/spreadsheets/d/1OrContixGYzHNT_DaO76p3rP1nvNamRs9r3fuJLsf-k/edit
        run: |
          python3 - <<'EOF'
          import os, json
          import gspread
          from google.oauth2.service_account import Credentials

          creds_json = os.environ["GOOGLE_SHEETS_CREDENTIALS"]
          sheet_url  = os.environ["SHEET_URL"]

          creds_dict = json.loads(creds_json)
          print(f"Service account: {creds_dict.get('client_email')}")

          scope = ["https://www.googleapis.com/auth/spreadsheets"]
          creds  = Credentials.from_service_account_info(creds_dict, scopes=scope)
          client = gspread.authorize(creds)

          sh = client.open_by_url(sheet_url)
          print("✓ Spreadsheet opened successfully")

          # Test 1: Try writing to the Redfin tab, Column D (not the main data columns)
          print("\n--- Test 1: Write to Redfin tab, Column D ---")
          try:
              ws = sh.worksheet("Redfin")
              ws.update_cell(2, 4, "TEST-D")
              print("✓ Column D write SUCCESS — Column C is likely protected")
          except Exception as e:
              print(f"✗ Column D write FAILED: {e}")

          # Test 2: Try writing to the Redfin tab, Column C directly
          print("\n--- Test 2: Write to Redfin tab, Column C ---")
          try:
              ws = sh.worksheet("Redfin")
              ws.update_cell(2, 3, "$TEST-123")
              print("✓ Column C write SUCCESS")
          except Exception as e:
              print(f"✗ Column C write FAILED: {e}")

          # Test 3: List all sheets and try writing to the first non-Redfin one
          print("\n--- Test 3: List all sheets ---")
          for s in sh.worksheets():
              print(f"  Sheet: '{s.title}'")

          # Test 4: Try adding a new test sheet and writing to it
          print("\n--- Test 4: Create temp sheet and write ---")
          try:
              temp = sh.add_worksheet(title="_temp_test", rows=2, cols=2)
              temp.update_cell(1, 1, "TEST")
              print("✓ New sheet write SUCCESS — Redfin tab has protected ranges")
              sh.del_worksheet(temp)
              print("✓ Temp sheet deleted")
          except Exception as e:
              print(f"✗ New sheet write FAILED: {e} — general permission issue")
          EOF
